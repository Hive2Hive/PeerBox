<!-- 
	note: download maven-ant-tasks*.jar from 
	http://maven.apache.org/ant-tasks/download.cgi 
	and place it in the lib folder of ant.
-->

<project name="PeerBox" default="none" basedir="../"
	xmlns:artifact="antlib:org.apache.maven.artifact.ant">
	<description>
        Build tasks for PeerBox
    </description>

	<!-- reference the PeerBox pom to get version information and maven functionality -->
	<artifact:pom id="peerbox_pom" file="peerbox/pom.xml" />

	<!-- set global properties for this build -->
	<property file="build/PeerBox.properties" />
	<property file="build/VisualStudio.properties" />
	<property file="build/WindowsContextMenu.properties" />
	<property file="build/launch4j.properties" />
	<property file="build/InnoSetup.properties" />

	<!-- create proper version property (for installer) -->
	<loadresource property="peerbox.version">
		<propertyresource name="peerbox_pom.version" />
		<filterchain>
			<tokenfilter>
				<filetokenizer />
				<replacestring from="-SNAPSHOT" to="" />
			</tokenfilter>
		</filterchain>
	</loadresource>


	<condition property="isWindows">
		<os family="windows" />
	</condition>
	<condition property="isUnix">
		<os family="unix" />
	</condition>

	<target name="none">
		<echo>Select a task</echo>
	</target>

	<!-- wrapper targets that depend on platform specific commands (conditional) -->
	<target name="mvn_clean" depends="win_mvn_clean" />
	<target name="mvn_package" depends="win_mvn_package" />

	<target name="win_mvn_clean" if="isWindows">
		<exec executable="cmd" failonerror="true">
			<arg value="/c" />
			<arg value="mvn clean -f ${peerbox.pomfile}" />
		</exec>
	</target>

	<target name="win_mvn_package" if="isWindows">
		<exec executable="cmd" failonerror="true">
			<arg value="/c" />
			<arg value="mvn package -f ${peerbox.pomfile}" />
			<arg value="-DskipTests" />
		</exec>
	</target>

	<target name="win_context_menu_x86" if="isWindows">
		<exec executable="${visual_studio.devenv}" failonerror="true">
			<arg value="${context_menu.solution}" />
			<arg value="/Rebuild" />
			<arg value="${context_menu.release.x86}" />
		</exec>
	</target>

	<target name="win_context_menu_x64" if="isWindows">
		<exec executable="${visual_studio.devenv}" failonerror="true">
			<arg value="${context_menu.solution}" />
			<arg value="/Rebuild" />
			<arg value="${context_menu.release.x64}" />
		</exec>
	</target>

	<target name="win_jar2exe_launcher" if="isWindows">
		<!-- fill in template placeholders -->
		<copy file="${launch4j.configtemplate}" tofile="${targetdir}/${launch4j.configname}" overwrite="true" />

		<replace file="${targetdir}/${launch4j.configname}">
			<replacefilter token="@PEERBOX_JAR@" value="${peerbox.jarname}" />
			<replacefilter token="@APP_VERSION@" value="${peerbox.version}" />
            <replacefilter token="@JAVA_VERSION_MIN@" value="${launch4.java_version_min}" />
		</replace>

		<exec executable="${launch4j.exe}" failonerror="true">
			<arg value="${targetdir}/${launch4j.configname}" />
		</exec>

	</target>

	<target name="win_installer_x86" if="isWindows">
		<!-- fill in template placeholders -->
		<copy file="${inno_setup.setup.configtemplate}" tofile="${inno_setup.setup.config}" overwrite="true" />

		<replace file="${inno_setup.setup.config}">
			<replacefilter token="@ARCHITECTURE_INSTALLER_FILE@" value="win_installer_x86.iss" />
			<replacefilter token="@BASE_DIR@" value="Windows_x86" />
			<replacefilter token="@PEERBOX_JAR@" value="${peerbox.jarname}" />
			<replacefilter token="@APP_VERSION@" value="${peerbox.version}" />
		</replace>

		<!-- execute the compiler -->
		<exec executable="${inno_setup.compiler}" failonerror="true">
			<arg value="${inno_setup.setup}" />
		</exec>

		<!-- move tmp config to target dir -->
		<move file="${inno_setup.setup.config}" todir="${peerbox.winbuild_x86}" failonerror="true" />
	</target>

	<target name="win_installer_x64" if="isWindows">
		<!-- fill in template placeholders -->
		<copy file="${inno_setup.setup.configtemplate}" tofile="${inno_setup.setup.config}" overwrite="true" />

		<replace file="${inno_setup.setup.config}">
			<replacefilter token="@ARCHITECTURE_INSTALLER_FILE@" value="win_installer_x64.iss" />
			<replacefilter token="@BASE_DIR@" value="Windows_x64" />
			<replacefilter token="@PEERBOX_JAR@" value="${peerbox.jarname}" />
			<replacefilter token="@APP_VERSION@" value="${peerbox.version}" />
		</replace>

		<!-- execute the compiler -->
		<exec executable="${inno_setup.compiler}" failonerror="true">
			<arg value="${inno_setup.setup}" />
		</exec>

		<!-- move tmp config to target dir -->
		<move file="${inno_setup.setup.config}" todir="${peerbox.winbuild_x64}" failonerror="true" />
	</target>

	<target name="win_package_all">
		<antcall target="win_package_x64" />
		<antcall target="win_package_x86" />
	</target>

	<target name="win_package_x64">
		<antcall target="init_target_dir">
			<param name="dirname" value="${peerbox.winbuild_x64}" />
		</antcall>

		<!-- build fresh package -->
		<antcall target="mvn_clean" />
		<antcall target="mvn_package" />
		<antcall target="copy_peerbox_package">
			<param name="targetdir" value="${peerbox.winbuild_x64}" />
		</antcall>

		<!-- build the context menu extensions -->
		<antcall target="win_context_menu_x64" />
		<echo>Copy ContextMenu extension ...</echo>
		<copy file="${context_menu.home}/x64/Release/ContextMenu.dll" todir="${peerbox.winbuild_x64}" failonerror="true" />
		<copy todir="${peerbox.winbuild_x64}" failonerror="true">
			<fileset dir="${context_menu.home}/x64/Release" includes="cpprest*.dll" />
		</copy>

		<!-- build the exe wrapper for launching the jar -->
		<antcall target="win_jar2exe_launcher">
			<param name="targetdir" value="${peerbox.winbuild_x64}" />
		</antcall>

		<!-- build the installer -->
		<antcall target="copy_installer_resources">
			<param name="targetdir" value="${peerbox.winbuild_x64}" />
		</antcall>
		<antcall target="win_installer_x64" />
	</target>

	<target name="win_package_x86">
		<antcall target="init_target_dir">
			<param name="dirname" value="${peerbox.winbuild_x86}" />
		</antcall>

		<!-- build fresh package -->
		<antcall target="mvn_clean" />
		<antcall target="mvn_package" />
		<antcall target="copy_peerbox_package">
			<param name="targetdir" value="${peerbox.winbuild_x86}" />
		</antcall>

		<!-- build the context menu extensions -->
		<antcall target="win_context_menu_x86" />
		<echo>Copy ContextMenu extension ...</echo>
		<copy file="${context_menu.home}/Release/ContextMenu.dll" todir="${peerbox.winbuild_x86}" failonerror="true" />
		<copy todir="${peerbox.winbuild_x86}" failonerror="true">
			<fileset dir="${context_menu.home}/Release" includes="cpprest*.dll" />
		</copy>

		<!-- build the exe wrapper for launching the jar -->
		<antcall target="win_jar2exe_launcher">
			<param name="targetdir" value="${peerbox.winbuild_x86}" />
		</antcall>

		<!-- build the installer -->
		<antcall target="copy_installer_resources">
			<param name="targetdir" value="${peerbox.winbuild_x86}" />
		</antcall>
		<antcall target="win_installer_x86" />
	</target>

	<target name="init_target_dir">
		<!-- delete old and create new build folder -->
		<delete dir="${dirname}" />
		<mkdir dir="${dirname}" />
		<echo>Create target directory: ${dirname}</echo>
	</target>

	<target name="copy_peerbox_package">
		<echo>Copy PeerBox package to ${targetdir} ...</echo>
		<copy file="${peerbox.jar}" todir="${targetdir}" failonerror="true" />
		<copy todir="${targetdir}/lib" failonerror="true">
			<fileset dir="${peerbox.build}/lib" />
		</copy>
	</target>

	<target name="copy_installer_resources">
		<echo>Copy resources ...</echo>
		<copy file="resources/peerbox64.ico" todir="${targetdir}" failonerror="true" />
		<copy file="resources/License.rtf" todir="${targetdir}" failonerror="true" />
	</target>

</project>